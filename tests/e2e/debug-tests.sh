#!/bin/bash

# –°–∫—Ä–∏–ø—Ç –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏ —Ç–µ—Å—Ç–æ–≤

set -e

echo "üêõ –û—Ç–ª–∞–¥–∫–∞ —Ç–µ—Å—Ç–æ–≤ –¥–ª—è —Å–∏—Å—Ç–µ–º—ã ICT..."

# –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –º—ã –≤ –ø—Ä–∞–≤–∏–ª—å–Ω–æ–π –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏
if [ ! -f "package.json" ]; then
    echo "‚ùå –û—à–∏–±–∫–∞: –ó–∞–ø—É—Å—Ç–∏—Ç–µ —Å–∫—Ä–∏–ø—Ç –∏–∑ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏ tests/e2e"
    exit 1
fi

# –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏ —Ç–µ—Å—Ç–æ–≤
debug_test() {
    local test_file="$1"
    local description="$2"
    
    echo ""
    echo "üîç –û—Ç–ª–∞–¥–∫–∞: $description"
    echo "üìÅ –§–∞–π–ª: $test_file"
    echo "‚è±Ô∏è –í—Ä–µ–º—è: $(date)"
    echo "----------------------------------------"
    
    # –ó–∞–ø—É—Å–∫ —Å –ø–æ–¥—Ä–æ–±–Ω—ã–º–∏ –ª–æ–≥–∞–º–∏
    DEBUG=pw:api npx playwright test "$test_file" --project=chromium --headed --debug
    
    echo "‚úÖ –û—Ç–ª–∞–¥–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞: $description"
    echo "‚è±Ô∏è –í—Ä–µ–º—è –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è: $(date)"
    echo "----------------------------------------"
}

# –§—É–Ω–∫—Ü–∏—è –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –∫–æ–¥–∞ —Ç–µ—Å—Ç–æ–≤
generate_test() {
    local url="$1"
    local description="$2"
    
    echo ""
    echo "üé® –ì–µ–Ω–µ—Ä–∞—Ü–∏—è —Ç–µ—Å—Ç–∞: $description"
    echo "üåê URL: $url"
    echo "----------------------------------------"
    
    npx playwright codegen "$url"
    
    echo "‚úÖ –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –∑–∞–≤–µ—Ä—à–µ–Ω–∞: $description"
    echo "----------------------------------------"
}

# –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ –æ—Ç—á–µ—Ç–æ–≤
view_reports() {
    echo ""
    echo "üìä –ü—Ä–æ—Å–º–æ—Ç—Ä –æ—Ç—á–µ—Ç–æ–≤..."
    echo "----------------------------------------"
    
    if [ -d "playwright-report" ]; then
        echo "üåê –û—Ç–∫—Ä—ã—Ç–∏–µ HTML –æ—Ç—á–µ—Ç–∞..."
        npx playwright show-report
    else
        echo "‚ùå –û—Ç—á–µ—Ç—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã. –ó–∞–ø—É—Å—Ç–∏—Ç–µ —Ç–µ—Å—Ç—ã —Å–Ω–∞—á–∞–ª–∞."
    fi
}

# –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ—á–∏—Å—Ç–∫–∏ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤
clean_results() {
    echo ""
    echo "üßπ –û—á–∏—Å—Ç–∫–∞ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ —Ç–µ—Å—Ç–æ–≤..."
    echo "----------------------------------------"
    
    rm -rf test-results/
    rm -rf playwright-report/
    rm -f test-results.json
    rm -f test-results.xml
    
    echo "‚úÖ –†–µ–∑—É–ª—å—Ç–∞—Ç—ã –æ—á–∏—â–µ–Ω—ã"
}

# –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ —Å–∏—Å—Ç–µ–º—ã
check_system() {
    echo ""
    echo "üîç –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–∏—Å—Ç–µ–º—ã..."
    echo "----------------------------------------"
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º Node.js
    echo "üì¶ Node.js –≤–µ—Ä—Å–∏—è: $(node --version)"
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º npm
    echo "üì¶ npm –≤–µ—Ä—Å–∏—è: $(npm --version)"
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º Playwright
    echo "üé≠ Playwright –≤–µ—Ä—Å–∏—è: $(npx playwright --version)"
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
    if curl -s http://localhost > /dev/null; then
        echo "‚úÖ –ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –¥–æ—Å—Ç—É–ø–Ω–æ –Ω–∞ http://localhost"
    else
        echo "‚ùå –ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–æ –Ω–∞ http://localhost"
        echo "üí° –ó–∞–ø—É—Å—Ç–∏—Ç–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –∫–æ–º–∞–Ω–¥–æ–π: ./vendor/bin/sail up -d"
    fi
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º –±—Ä–∞—É–∑–µ—Ä—ã
    echo "üåê –ü—Ä–æ–≤–µ—Ä–∫–∞ –±—Ä–∞—É–∑–µ—Ä–æ–≤..."
    npx playwright install --dry-run
}

# –ú–µ–Ω—é –æ—Ç–ª–∞–¥–∫–∏
case "${1:-menu}" in
    "auth")
        debug_test "auth.spec.js" "–û—Ç–ª–∞–¥–∫–∞ —Ç–µ—Å—Ç–æ–≤ –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏"
        ;;
    "tickets")
        debug_test "tickets.spec.js" "–û—Ç–ª–∞–¥–∫–∞ —Ç–µ—Å—Ç–æ–≤ –∑–∞—è–≤–æ–∫"
        ;;
    "equipment")
        debug_test "equipment.spec.js" "–û—Ç–ª–∞–¥–∫–∞ —Ç–µ—Å—Ç–æ–≤ –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏—è"
        ;;
    "rooms")
        debug_test "rooms.spec.js" "–û—Ç–ª–∞–¥–∫–∞ —Ç–µ—Å—Ç–æ–≤ –∫–∞–±–∏–Ω–µ—Ç–æ–≤"
        ;;
    "users")
        debug_test "users.spec.js" "–û—Ç–ª–∞–¥–∫–∞ —Ç–µ—Å—Ç–æ–≤ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π"
        ;;
    "knowledge")
        debug_test "knowledge.spec.js" "–û—Ç–ª–∞–¥–∫–∞ —Ç–µ—Å—Ç–æ–≤ –±–∞–∑—ã –∑–Ω–∞–Ω–∏–π"
        ;;
    "notifications")
        debug_test "notifications.spec.js" "–û—Ç–ª–∞–¥–∫–∞ —Ç–µ—Å—Ç–æ–≤ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π"
        ;;
    "integration")
        debug_test "integration.spec.js" "–û—Ç–ª–∞–¥–∫–∞ –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–æ–Ω–Ω—ã—Ö —Ç–µ—Å—Ç–æ–≤"
        ;;
    "errors")
        debug_test "error-handling.spec.js" "–û—Ç–ª–∞–¥–∫–∞ —Ç–µ—Å—Ç–æ–≤ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –æ—à–∏–±–æ–∫"
        ;;
    "performance")
        debug_test "performance.spec.js" "–û—Ç–ª–∞–¥–∫–∞ —Ç–µ—Å—Ç–æ–≤ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏"
        ;;
    "security")
        debug_test "security.spec.js" "–û—Ç–ª–∞–¥–∫–∞ —Ç–µ—Å—Ç–æ–≤ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏"
        ;;
    "generate")
        generate_test "http://localhost" "–ì–µ–Ω–µ—Ä–∞—Ü–∏—è —Ç–µ—Å—Ç–æ–≤ –¥–ª—è –≥–ª–∞–≤–Ω–æ–π —Å—Ç—Ä–∞–Ω–∏—Ü—ã"
        ;;
    "reports")
        view_reports
        ;;
    "clean")
        clean_results
        ;;
    "check")
        check_system
        ;;
    "menu")
        echo "üêõ –ú–µ–Ω—é –æ—Ç–ª–∞–¥–∫–∏ —Ç–µ—Å—Ç–æ–≤:"
        echo ""
        echo "üîç –û—Ç–ª–∞–¥–∫–∞ –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã—Ö —Ç–µ—Å—Ç–æ–≤:"
        echo "  ./debug-tests.sh auth          - –û—Ç–ª–∞–¥–∫–∞ —Ç–µ—Å—Ç–æ–≤ –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏"
        echo "  ./debug-tests.sh tickets       - –û—Ç–ª–∞–¥–∫–∞ —Ç–µ—Å—Ç–æ–≤ –∑–∞—è–≤–æ–∫"
        echo "  ./debug-tests.sh equipment     - –û—Ç–ª–∞–¥–∫–∞ —Ç–µ—Å—Ç–æ–≤ –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏—è"
        echo "  ./debug-tests.sh rooms         - –û—Ç–ª–∞–¥–∫–∞ —Ç–µ—Å—Ç–æ–≤ –∫–∞–±–∏–Ω–µ—Ç–æ–≤"
        echo "  ./debug-tests.sh users         - –û—Ç–ª–∞–¥–∫–∞ —Ç–µ—Å—Ç–æ–≤ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π"
        echo "  ./debug-tests.sh knowledge     - –û—Ç–ª–∞–¥–∫–∞ —Ç–µ—Å—Ç–æ–≤ –±–∞–∑—ã –∑–Ω–∞–Ω–∏–π"
        echo "  ./debug-tests.sh notifications - –û—Ç–ª–∞–¥–∫–∞ —Ç–µ—Å—Ç–æ–≤ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π"
        echo "  ./debug-tests.sh integration   - –û—Ç–ª–∞–¥–∫–∞ –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–æ–Ω–Ω—ã—Ö —Ç–µ—Å—Ç–æ–≤"
        echo "  ./debug-tests.sh errors        - –û—Ç–ª–∞–¥–∫–∞ —Ç–µ—Å—Ç–æ–≤ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –æ—à–∏–±–æ–∫"
        echo "  ./debug-tests.sh performance   - –û—Ç–ª–∞–¥–∫–∞ —Ç–µ—Å—Ç–æ–≤ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏"
        echo "  ./debug-tests.sh security      - –û—Ç–ª–∞–¥–∫–∞ —Ç–µ—Å—Ç–æ–≤ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏"
        echo ""
        echo "üõ†Ô∏è –ò–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã:"
        echo "  ./debug-tests.sh generate     - –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –Ω–æ–≤—ã—Ö —Ç–µ—Å—Ç–æ–≤"
        echo "  ./debug-tests.sh reports       - –ü—Ä–æ—Å–º–æ—Ç—Ä –æ—Ç—á–µ—Ç–æ–≤"
        echo "  ./debug-tests.sh clean         - –û—á–∏—Å—Ç–∫–∞ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤"
        echo "  ./debug-tests.sh check         - –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–∏—Å—Ç–µ–º—ã"
        echo ""
        echo "üí° –ü—Ä–∏–º–µ—Ä—ã –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è:"
        echo "  ./debug-tests.sh auth          # –û—Ç–ª–∞–¥–∫–∞ —Ç–µ—Å—Ç–æ–≤ –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏"
        echo "  ./debug-tests.sh generate      # –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –Ω–æ–≤—ã—Ö —Ç–µ—Å—Ç–æ–≤"
        echo "  ./debug-tests.sh reports       # –ü—Ä–æ—Å–º–æ—Ç—Ä –æ—Ç—á–µ—Ç–æ–≤"
        echo "  ./debug-tests.sh check         # –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–∏—Å—Ç–µ–º—ã"
        ;;
    *)
        echo "‚ùå –ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –∫–æ–º–∞–Ω–¥–∞: $1"
        echo "–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ './debug-tests.sh menu' –¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ –¥–æ—Å—Ç—É–ø–Ω—ã—Ö –∫–æ–º–∞–Ω–¥"
        exit 1
        ;;
esac

echo ""
echo "‚úÖ –û—Ç–ª–∞–¥–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞!"
echo "üìä –û—Ç—á–µ—Ç—ã –¥–æ—Å—Ç—É–ø–Ω—ã –≤ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏ playwright-report/"
echo "üé• –í–∏–¥–µ–æ –∏ —Å–∫—Ä–∏–Ω—à–æ—Ç—ã –¥–æ—Å—Ç—É–ø–Ω—ã –≤ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏ test-results/"
