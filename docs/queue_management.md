# Управление очередями в системе ICT

В этом документе описаны принципы работы с очередями для отправки электронной почты и других асинхронных задач в системе ICT.

## Зачем нужны очереди

Очереди позволяют выполнять ресурсоемкие задачи асинхронно, что значительно улучшает производительность системы:

1. **Ускорение отклика системы** - пользователь не ждет завершения отправки письма
2. **Повышение надежности** - даже если отправка письма временно невозможна, задание останется в очереди
3. **Распределение нагрузки** - задачи выполняются последовательно, не перегружая сервер
4. **Возможность повторных попыток** - если задача завершилась с ошибкой, система может попробовать ещё раз

## Настройка очередей

В системе ICT очереди настроены на использование базы данных для хранения заданий:

### 1. Параметры в .env файле

```env
QUEUE_CONNECTION=database
```

### 2. Таблицы в базе данных

Для работы очередей используются следующие таблицы:
- `jobs` - основная таблица для хранения заданий
- `failed_jobs` - таблица для хранения информации о заданиях, которые завершились с ошибкой

## Управление очередями

### Скрипт управления

Для удобства управления очередями в системе предусмотрен скрипт `queue_manager.sh`, который позволяет выполнять основные операции:

```bash
# Запуск обработчика очереди
./queue_manager.sh start

# Остановка обработчика
./queue_manager.sh stop

# Перезапуск обработчика
./queue_manager.sh restart

# Проверка статуса
./queue_manager.sh status

# Просмотр заданий в очереди
./queue_manager.sh list

# Просмотр логов
./queue_manager.sh logs

# Отправка тестового email
./queue_manager.sh test
```

### Управление через Artisan

Помимо скрипта, можно использовать стандартные команды Laravel:

```bash
# Запуск обработчика
php artisan queue:work

# Запуск с ограничением времени работы (3600 секунд)
php artisan queue:work --max-time=3600

# Просмотр количества заданий в очереди
php artisan queue:size

# Очистка очереди (все задания будут удалены)
php artisan queue:clear

# Просмотр списка невыполненных заданий
php artisan queue:failed
```

## Настройка Supervisor (для Production)

Для обеспечения постоянной работы очередей в production-среде рекомендуется использовать Supervisor.

### Файл конфигурации

Файл конфигурации `laravel-worker.conf` уже подготовлен и расположен в корне проекта. Его нужно скопировать в директорию `/etc/supervisor/conf.d/`:

```bash
sudo cp laravel-worker.conf /etc/supervisor/conf.d/
```

### Управление через Supervisor

```bash
# Обновление конфигурации Supervisor
sudo supervisorctl reread
sudo supervisorctl update

# Запуск обработчиков
sudo supervisorctl start laravel-worker:*

# Остановка обработчиков
sudo supervisorctl stop laravel-worker:*

# Проверка статуса
sudo supervisorctl status
```

## Логирование и отладка

### Логи очередей

Логи обработчика очередей сохраняются в файл `storage/logs/queue.log`.

Для просмотра последних записей:

```bash
tail -n 50 storage/logs/queue.log
```

### Отладка ошибок

Если задания не выполняются или завершаются с ошибкой:

1. Проверьте наличие заданий в очереди:
   ```bash
   php artisan queue:size
   ```

2. Проверьте статус обработчика:
   ```bash
   ./queue_manager.sh status
   ```

3. Просмотрите логи Laravel:
   ```bash
   tail -n 100 storage/logs/laravel.log
   ```

4. Проверьте наличие заданий в таблице failed_jobs:
   ```bash
   php artisan queue:failed
   ```

## Отправка тестовых писем

Для проверки работы очередей и настроек SMTP можно отправить тестовое письмо:

```bash
php artisan test:email-notifications --email=your-email@example.com
```

Эта команда отправит тестовое уведомление о сбросе пароля и активации учетной записи через очередь.

## Рекомендации по эксплуатации

1. **Регулярно проверяйте логи** - это поможет выявить проблемы на ранней стадии
2. **Настройте мониторинг** - следите за размером очереди и количеством неудачных заданий
3. **Оптимизируйте количество обработчиков** - подберите оптимальное число в зависимости от нагрузки
4. **Очищайте таблицу failed_jobs** - периодически удаляйте старые неудачные задания
5. **Установите лимиты** - ограничьте время выполнения заданий и количество повторных попыток

## Устранение проблем

| Проблема | Возможное решение |
|----------|-------------------|
| Письма не отправляются | Проверьте настройки SMTP, запущены ли обработчики очередей |
| Обработчик падает | Проверьте логи на наличие ошибок, возможно нехватка памяти |
| Очередь растет | Увеличьте количество обработчиков или проверьте производительность SMTP |
| Много неудачных заданий | Проверьте типичные ошибки в логах и настройте правильные лимиты повторных попыток |