# Улучшенная версия Telegram-бота для системы заявок

## Введение

Данная документация описывает улучшенную версию Telegram-бота для системы заявок ICT. В ней устранены проблемы с дублированием уведомлений, стандартизированы команды, улучшена интеграция с Docker и добавлен расширенный инструментарий для управления ботом.

## Изменения в новой версии

### 1. Устранение дублирования уведомлений

- Создана таблица `sent_telegram_notifications` для отслеживания отправленных уведомлений
- Внедрена проверка на дублирование перед каждой отправкой уведомления
- Добавлена блокировка для предотвращения одновременной отправки уведомлений

### 2. Стандартизация формата команд

Все команды теперь используют единый формат с символом подчеркивания:
- `/ticket_{id}` - просмотр заявки
- `/start_ticket_{id}` - взятие заявки в работу
- `/assign_{id}` - назначение заявки себе
- `/resolve_{id}` - отметка заявки как решенной

### 3. Улучшенная интеграция с Docker

- Обновлен `docker-compose.telegram.yml` с добавлением проверок здоровья и логирования
- Добавлена проверка на наличие токена в контейнере
- Улучшен скрипт запуска бота с автоматическим перезапуском при сбоях

### 4. Новый инструментарий управления ботом

- Создан скрипт `manage_bots.sh` для комплексного управления ботом
- Добавлены функции диагностики и устранения дубликатов

## Установка и настройка

### Предварительные требования

- Laravel 12+
- PHP 8.2+
- Docker и Docker Compose
- Установленные пакеты BotMan и Telegram Driver

### Шаги настройки

1. **Обновление кодовой базы**

   Все необходимые изменения уже внесены в кодовую базу проекта. Вам нужно только применить миграции для создания новых таблиц:

   ```bash
   ./vendor/bin/sail artisan migrate
   ```

2. **Проверка настройки токена**

   Убедитесь, что токен Telegram бота правильно указан в `.env` файле:

   ```
   TELEGRAM_BOT_TOKEN=your_token_here
   ```

3. **Проверка работоспособности бота**

   Запустите диагностику для проверки всех компонентов:

   ```bash
   ./manage_bots.sh diagnose
   ```

## Использование нового инструментария

### Управление ботом через `manage_bots.sh`

Новый скрипт `manage_bots.sh` предоставляет следующие команды:

- `./manage_bots.sh start` - Запуск бота
- `./manage_bots.sh stop` - Остановка бота
- `./manage_bots.sh restart` - Перезапуск бота
- `./manage_bots.sh status` - Проверка статуса бота
- `./manage_bots.sh logs` - Просмотр логов бота
- `./manage_bots.sh cleanup` - Устранение дубликатов ботов
- `./manage_bots.sh diagnose` - Диагностика проблем

### Пример использования при развертывании

1. **Первоначальная настройка**:

   ```bash
   # Проверка настроек
   ./manage_bots.sh diagnose
   
   # Запуск бота
   ./manage_bots.sh start
   
   # Проверка статуса
   ./manage_bots.sh status
   ```

2. **Обновление после изменений в коде**:

   ```bash
   # Остановка бота
   ./manage_bots.sh stop
   
   # Перезапуск после обновлений
   ./manage_bots.sh start
   ```

3. **Устранение проблем**:

   ```bash
   # Диагностика проблем
   ./manage_bots.sh diagnose
   
   # Устранение дубликатов
   ./manage_bots.sh cleanup
   
   # Просмотр логов
   ./manage_bots.sh logs
   ```

## Доступные команды бота

### Команды для пользователей:

- `/start` - Начало работы с ботом
- `/help` - Показать справку по командам
- `/login` - Авторизация в системе
- `/logout` - Выйти из системы

### Команды для работы с заявками:

- `/tickets` - Показать список текущих заявок
- `/ticket_{id}` - Показать подробную информацию о заявке
- `/start_ticket_{id}` - Взять заявку в работу
- `/assign_{id}` - Назначить заявку себе
- `/resolve_{id}` - Отметить заявку как решенную

## Авторизация пользователей

Авторизация осуществляется по номеру телефона и паролю. Процесс авторизации:

1. Отправьте команду `/login`
2. Введите номер телефона, когда бот запросит его
3. Введите пароль
4. После успешной авторизации ваш Telegram ID будет привязан к учетной записи в системе

## Автоматические уведомления

Бот автоматически отправляет уведомления о новых заявках всем пользователям с ролями "admin", "master" и "technician", у которых настроена интеграция с Telegram (привязан Telegram ID). Для получения уведомлений необходимо:

1. Авторизоваться в боте хотя бы один раз
2. Иметь соответствующую роль в системе

## Устранение неполадок

### Проблема: Бот не отвечает на команды

1. Проверьте, запущен ли бот: `./manage_bots.sh status`
2. Выполните диагностику: `./manage_bots.sh diagnose`
3. Проверьте логи: `./manage_bots.sh logs`
4. Перезапустите бота: `./manage_bots.sh restart`

### Проблема: Дублирующиеся уведомления

1. Запустите очистку дубликатов: `./manage_bots.sh cleanup`
2. Проверьте, что нет нескольких экземпляров бота: `./manage_bots.sh status`

### Проблема: Не работает авторизация

1. Убедитесь, что вы вводите правильный формат номера телефона
2. Проверьте, что ваша учетная запись активна в системе
3. Проверьте соответствие номера телефона в Telegram и в системе

## Заключение

Улучшенная версия Telegram-бота обеспечивает более стабильную работу и устраняет проблемы, которые были в предыдущей версии. Новый инструментарий управления позволяет легко диагностировать и устранять возникающие проблемы, а также следить за состоянием бота.

Для получения дополнительной информации обратитесь к разработчику системы или изучите исходный код в соответствующих директориях проекта:
- `app/Console/Commands/` - Артизан-команды для работы с ботом
- `app/Http/Controllers/TelegramBotController.php` - Основной контроллер бота
- `app/Services/NotificationService.php` - Сервис уведомлений
- `app/Models/SentTelegramNotification.php` - Модель для отслеживания отправленных уведомлений