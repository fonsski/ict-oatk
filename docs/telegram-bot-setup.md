# Настройка и использование Telegram-бота для системы заявок

## Описание

Телеграм-бот предоставляет сотрудникам удобный интерфейс для работы с заявками через мессенджер Telegram. Основные возможности:

- Получение уведомлений о новых заявках
- Просмотр списка активных заявок
- Взятие заявок в работу
- Назначение заявок на себя
- Полная синхронизация с веб-интерфейсом системы

## Предварительные требования

- Laravel 12+
- PHP 8.2+
- Установленные пакеты BotMan и Telegram Driver

## Настройка бота

### 1. Создание бота в Telegram

1. Откройте Telegram и найдите пользователя [@BotFather](https://t.me/BotFather)
2. Отправьте команду `/newbot`
3. Следуйте инструкциям для создания нового бота:
   - Укажите имя бота (например, "ICT Helpdesk")
   - Укажите юзернейм для бота (должен заканчиваться на "bot", например, "ict_helpdesk_bot")
4. После создания бота BotFather выдаст вам токен, который нужно сохранить

### 2. Настройка переменных окружения

Добавьте в файл `.env` следующую переменную:

```
TELEGRAM_BOT_TOKEN=ваш_токен_от_botfather
```

### 3. Настройка Webhook

Для обработки сообщений от Telegram нужно настроить webhook. Используйте следующую команду:

```bash
./vendor/bin/sail artisan telegram:set-webhook
```

Если ваш проект доступен по нестандартному URL, укажите его явно:

```bash
./vendor/bin/sail artisan telegram:set-webhook https://your-domain.com/api/telegram/webhook
```

### 4. Запуск миграций

Запустите миграцию для добавления поля `telegram_id` в таблицу пользователей:

```bash
./vendor/bin/sail artisan migrate
```

## Использование бота

### Авторизация

1. Откройте созданного бота в Telegram
2. Отправьте команду `/start` для получения приветственного сообщения
3. Отправьте команду `/login` для начала процесса авторизации
4. Введите ваш email и пароль от учетной записи в системе
5. После успешной авторизации бот сохранит вашу сессию и привяжет ваш Telegram ID к учетной записи

### Основные команды

- `/start` - Начало работы с ботом
- `/login` - Авторизация в системе
- `/tickets` - Показать список текущих заявок
- `/ticket {id}` - Показать подробную информацию о заявке
- `/start_ticket {id}` - Взять заявку в работу
- `/assign {id}` - Назначить заявку себе
- `/logout` - Выйти из системы
- `/help` - Показать справку по командам

### Уведомления

После настройки бота, все пользователи с правами на управление заявками (администраторы, мастера, техники) будут получать уведомления о новых заявках в Telegram. Для этого необходимо:

1. Авторизоваться в боте хотя бы один раз, чтобы привязать Telegram ID к учетной записи
2. Иметь соответствующую роль в системе

## Устранение неполадок

### Бот не отвечает на сообщения

1. Проверьте, правильно ли указан токен бота в .env файле
2. Убедитесь, что webhook настроен корректно с помощью команды:
   ```
   curl -X GET https://api.telegram.org/bot{TELEGRAM_BOT_TOKEN}/getWebhookInfo
   ```
3. Проверьте логи Laravel на наличие ошибок

### Ошибка с webhook

Если webhook не работает, попробуйте:

1. Удалить текущий webhook:
   ```
   ./vendor/bin/sail artisan telegram:delete-webhook
   ```
2. Настроить webhook заново

### Проблемы с авторизацией

1. Убедитесь, что ваша учетная запись активна
2. Проверьте, правильно ли вы вводите email и пароль
3. Проверьте, имеет ли ваша учетная запись права на работу с заявками

## Разработка и расширение

Основные компоненты бота:

- `TelegramBotController` - основной контроллер для обработки сообщений
- `LoginConversation` - класс для реализации диалога авторизации
- `NotificationService` - сервис для отправки уведомлений

Для добавления новых команд или возможностей, модифицируйте метод `setupConversations` в `TelegramBotController`.