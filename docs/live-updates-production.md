# Live Updates - Инструкции для продакшена

## Обзор

Система live-обновления заявок была полностью переработана для обеспечения стабильной работы в продакшене. Основные улучшения:

- ✅ Улучшенная обработка ошибок
- ✅ Автоматические повторные попытки
- ✅ Правильная обработка аутентификации
- ✅ Совместимость с HTTPS
- ✅ Оптимизированная производительность

## Изменения

### 1. Новый класс LiveUpdates

Создан новый JavaScript класс `LiveUpdates` в файле `resources/js/live-updates.js`:

- Автоматическое управление интервалами
- Обработка ошибок с повторными попытками
- Правильная обработка аутентификации
- Поддержка видимости страницы

### 2. Обновленные представления

#### `home.blade.php`
- Использует новый класс LiveUpdates
- Улучшенная обработка ошибок
- Правильная инициализация элементов

#### `all.blade.php`
- Использует новый класс LiveUpdates
- Улучшенная обработка ошибок
- Правильная инициализация элементов

### 3. Обновленный Vite конфиг

Добавлен новый файл в `vite.config.js`:
```javascript
"resources/js/live-updates.js"
```

## Настройка для продакшена

### 1. Сборка ресурсов

```bash
npm run build
```

### 2. Проверка CSRF токена

Убедитесь, что в `layouts/app.blade.php` есть:
```html
<meta name="csrf-token" content="{{ csrf_token() }}">
```

### 3. Настройка веб-сервера

#### Nginx
```nginx
location / {
    try_files $uri $uri/ /index.php?$query_string;
    
    # Кэширование для API endpoints
    location ~* ^/(home/technician/tickets|all-tickets/api) {
        add_header Cache-Control "no-cache, no-store, must-revalidate";
        add_header Pragma "no-cache";
        add_header Expires "0";
    }
}
```

#### Apache
```apache
<LocationMatch "/(home/technician/tickets|all-tickets/api)">
    Header set Cache-Control "no-cache, no-store, must-revalidate"
    Header set Pragma "no-cache"
    Header set Expires "0"
</LocationMatch>
```

### 4. Настройка Laravel

#### Конфигурация сессий
В `.env`:
```env
SESSION_DRIVER=file
SESSION_LIFETIME=120
SESSION_ENCRYPT=false
SESSION_PATH=/
SESSION_DOMAIN=yourdomain.com
```

#### Конфигурация CORS (если нужно)
В `config/cors.php`:
```php
'paths' => ['api/*', 'home/technician/tickets', 'all-tickets/api'],
'allowed_methods' => ['*'],
'allowed_origins' => ['*'],
'allowed_headers' => ['*'],
'exposed_headers' => [],
'max_age' => 0,
'supports_credentials' => true,
```

## Мониторинг

### 1. Логи

Проверьте логи Laravel:
```bash
tail -f storage/logs/laravel.log
```

### 2. Консоль браузера

Откройте Developer Tools (F12) и проверьте консоль на наличие ошибок.

### 3. Сетевые запросы

В Developer Tools → Network проверьте:
- Статус ответов API (должны быть 200)
- Время ответа
- Размер ответов

## Устранение неполадок

### Проблема: Live-обновление не работает

**Решение:**
1. Проверьте консоль браузера на ошибки
2. Убедитесь, что API endpoints доступны
3. Проверьте CSRF токен
4. Убедитесь, что пользователь авторизован

### Проблема: Ошибки 401/403

**Решение:**
1. Проверьте сессию пользователя
2. Убедитесь, что пользователь имеет нужные права
3. Проверьте middleware аутентификации

### Проблема: Медленная работа

**Решение:**
1. Увеличьте интервал обновления в коде
2. Оптимизируйте запросы к базе данных
3. Добавьте кэширование

## Тестирование

### 1. Локальное тестирование

```bash
php artisan serve
npm run dev
```

### 2. Тестирование в продакшене

1. Откройте страницу с заявками
2. Откройте Developer Tools (F12)
3. Проверьте консоль на ошибки
4. Проверьте Network на успешные запросы
5. Создайте новую заявку и проверьте обновление

## Производительность

### Рекомендуемые настройки

- **Интервал обновления:** 30 секунд (по умолчанию)
- **Максимальное количество повторных попыток:** 3
- **Задержка между попытками:** 5 секунд (экспоненциальная)

### Оптимизация

1. Используйте кэширование для статистики
2. Ограничьте количество заявок в ответе API
3. Используйте индексы в базе данных
4. Настройте CDN для статических ресурсов

## Безопасность

### 1. CSRF защита

Все API запросы защищены CSRF токенами.

### 2. Аутентификация

Проверяется авторизация пользователя и его права доступа.

### 3. Валидация

Все входящие данные валидируются на сервере.

## Поддержка

При возникновении проблем:

1. Проверьте логи Laravel
2. Проверьте консоль браузера
3. Проверьте сетевые запросы
4. Обратитесь к разработчику

---

**Дата создания:** {{ date('Y-m-d H:i:s') }}
**Версия:** 1.0
**Автор:** AI Assistant
