<?php

namespace App\Console\Commands;

use App\Models\Ticket;
use App\Models\User;
use App\Services\NotificationService;
use Illuminate\Console\Command;
use Illuminate\Support\Facades\Auth;

class TestNotificationSystem extends Command
{
    /**
     * The name and signature of the console command.
     *
     * @var string
     */
    protected $signature = "test:notifications {--create-ticket} {--user-id=}";

    /**
     * The console command description.
     *
     * @var string
     */
    protected $description = "Ğ¢ĞµÑÑ‚Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ ÑĞ¸ÑÑ‚ĞµĞ¼Ñ‹ ÑƒĞ²ĞµĞ´Ğ¾Ğ¼Ğ»ĞµĞ½Ğ¸Ğ¹";

    protected $notificationService;

    public function __construct(NotificationService $notificationService)
    {
        parent::__construct();
        $this->notificationService = $notificationService;
    }

    /**
     * Execute the console command.
     */
    public function handle()
    {
        $this->info("ğŸ”” Ğ¢ĞµÑÑ‚Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ ÑĞ¸ÑÑ‚ĞµĞ¼Ñ‹ ÑƒĞ²ĞµĞ´Ğ¾Ğ¼Ğ»ĞµĞ½Ğ¸Ğ¹");
        $this->newLine();

        // ĞŸĞ¾Ğ»ÑƒÑ‡Ğ°ĞµĞ¼ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ñ Ğ´Ğ»Ñ Ñ‚ĞµÑÑ‚Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ
        $userId = $this->option("user-id");
        if ($userId) {
            $user = User::find($userId);
            if (!$user) {
                $this->error("ĞŸĞ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ÑŒ Ñ ID {$userId} Ğ½Ğµ Ğ½Ğ°Ğ¹Ğ´ĞµĞ½!");
                return 1;
            }
        } else {
            $user = User::whereHas("role", function ($q) {
                $q->whereIn("slug", ["admin", "master", "technician"]);
            })->first();

            if (!$user) {
                $this->error(
                    "ĞĞµ Ğ½Ğ°Ğ¹Ğ´ĞµĞ½Ğ¾ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ĞµĞ¹ Ñ Ğ¿Ñ€Ğ°Ğ²Ğ°Ğ¼Ğ¸ Ğ¿Ğ¾Ğ»ÑƒÑ‡ĞµĞ½Ğ¸Ñ ÑƒĞ²ĞµĞ´Ğ¾Ğ¼Ğ»ĞµĞ½Ğ¸Ğ¹!",
                );
                return 1;
            }
        }

        $this->info("Ğ˜ÑĞ¿Ğ¾Ğ»ÑŒĞ·ÑƒĞµĞ¼ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ñ: {$user->name} ({$user->email})");
        $this->newLine();

        // Ğ¢ĞµÑÑ‚Ğ¸Ñ€ÑƒĞµĞ¼ API endpoint Ğ´Ğ»Ñ Ğ¿Ğ¾Ğ»ÑƒÑ‡ĞµĞ½Ğ¸Ñ ĞºĞ¾Ğ»Ğ¸Ñ‡ĞµÑÑ‚Ğ²Ğ° ÑƒĞ²ĞµĞ´Ğ¾Ğ¼Ğ»ĞµĞ½Ğ¸Ğ¹
        $this->info("1. Ğ¢ĞµÑÑ‚Ğ¸Ñ€ÑƒĞµĞ¼ Ğ¿Ğ¾Ğ»ÑƒÑ‡ĞµĞ½Ğ¸Ğµ Ñ‚ĞµĞºÑƒÑ‰Ğ¸Ñ… ÑƒĞ²ĞµĞ´Ğ¾Ğ¼Ğ»ĞµĞ½Ğ¸Ğ¹...");
        $currentCount = $this->notificationService->getUnreadCount($user);
        $this->line("   âœ… ĞĞµĞ¿Ñ€Ğ¾Ñ‡Ğ¸Ñ‚Ğ°Ğ½Ğ½Ñ‹Ñ… ÑƒĞ²ĞµĞ´Ğ¾Ğ¼Ğ»ĞµĞ½Ğ¸Ğ¹: {$currentCount}");

        // Ğ¡Ğ¾Ğ·Ğ´Ğ°ĞµĞ¼ Ñ‚ĞµÑÑ‚Ğ¾Ğ²Ğ¾Ğµ ÑƒĞ²ĞµĞ´Ğ¾Ğ¼Ğ»ĞµĞ½Ğ¸Ğµ Ğ½Ğ°Ğ¿Ñ€ÑĞ¼ÑƒÑ
        $this->info("2. Ğ¡Ğ¾Ğ·Ğ´Ğ°ĞµĞ¼ Ñ‚ĞµÑÑ‚Ğ¾Ğ²Ğ¾Ğµ ÑƒĞ²ĞµĞ´Ğ¾Ğ¼Ğ»ĞµĞ½Ğ¸Ğµ...");
        $this->createTestNotification($user);
        $this->line("   âœ… Ğ¢ĞµÑÑ‚Ğ¾Ğ²Ğ¾Ğµ ÑƒĞ²ĞµĞ´Ğ¾Ğ¼Ğ»ĞµĞ½Ğ¸Ğµ ÑĞ¾Ğ·Ğ´Ğ°Ğ½Ğ¾");

        // ĞŸÑ€Ğ¾Ğ²ĞµÑ€ÑĞµĞ¼, ÑƒĞ²ĞµĞ»Ğ¸Ñ‡Ğ¸Ğ»Ğ¾ÑÑŒ Ğ»Ğ¸ ĞºĞ¾Ğ»Ğ¸Ñ‡ĞµÑÑ‚Ğ²Ğ¾
        $newCount = $this->notificationService->getUnreadCount($user);
        $this->line("   âœ… ĞĞ¾Ğ²Ğ¾Ğµ ĞºĞ¾Ğ»Ğ¸Ñ‡ĞµÑÑ‚Ğ²Ğ¾ Ğ½ĞµĞ¿Ñ€Ğ¾Ñ‡Ğ¸Ñ‚Ğ°Ğ½Ğ½Ñ‹Ñ…: {$newCount}");

        // Ğ¡Ğ¾Ğ·Ğ´Ğ°ĞµĞ¼ Ñ‚ĞµÑÑ‚Ğ¾Ğ²ÑƒÑ Ğ·Ğ°ÑĞ²ĞºÑƒ, ĞµÑĞ»Ğ¸ ÑƒĞºĞ°Ğ·Ğ°Ğ½Ğ° Ğ¾Ğ¿Ñ†Ğ¸Ñ
        if ($this->option("create-ticket")) {
            $this->info("3. Ğ¡Ğ¾Ğ·Ğ´Ğ°ĞµĞ¼ Ñ‚ĞµÑÑ‚Ğ¾Ğ²ÑƒÑ Ğ·Ğ°ÑĞ²ĞºÑƒ...");
            $ticket = $this->createTestTicket($user);
            $this->line(
                "   âœ… Ğ¡Ğ¾Ğ·Ğ´Ğ°Ğ½Ğ° Ğ·Ğ°ÑĞ²ĞºĞ° #{$ticket->id}: {$ticket->title}",
            );

            // ĞÑ‚Ğ¿Ñ€Ğ°Ğ²Ğ»ÑĞµĞ¼ ÑƒĞ²ĞµĞ´Ğ¾Ğ¼Ğ»ĞµĞ½Ğ¸Ğµ Ğ¾ Ğ·Ğ°ÑĞ²ĞºĞµ
            $this->notificationService->notifyNewTicket($ticket);
            $this->line("   âœ… Ğ£Ğ²ĞµĞ´Ğ¾Ğ¼Ğ»ĞµĞ½Ğ¸Ñ Ğ¾ Ğ·Ğ°ÑĞ²ĞºĞµ Ğ¾Ñ‚Ğ¿Ñ€Ğ°Ğ²Ğ»ĞµĞ½Ñ‹");
        }

        // ĞŸĞ¾ĞºĞ°Ğ·Ñ‹Ğ²Ğ°ĞµĞ¼ Ğ¸Ğ½ÑÑ‚Ñ€ÑƒĞºÑ†Ğ¸Ğ¸ Ğ´Ğ»Ñ Ñ‚ĞµÑÑ‚Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ Ğ² Ğ±Ñ€Ğ°ÑƒĞ·ĞµÑ€Ğµ
        $this->newLine();
        $this->info("ğŸŒ Ğ˜Ğ½ÑÑ‚Ñ€ÑƒĞºÑ†Ğ¸Ğ¸ Ğ´Ğ»Ñ Ñ‚ĞµÑÑ‚Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ Ğ² Ğ±Ñ€Ğ°ÑƒĞ·ĞµÑ€Ğµ:");
        $this->line("1. ĞÑ‚ĞºÑ€Ğ¾Ğ¹Ñ‚Ğµ Ğ¿Ñ€Ğ¸Ğ»Ğ¾Ğ¶ĞµĞ½Ğ¸Ğµ Ğ² Ğ±Ñ€Ğ°ÑƒĞ·ĞµÑ€Ğµ");
        $this->line(
            "2. ĞĞ²Ñ‚Ğ¾Ñ€Ğ¸Ğ·ÑƒĞ¹Ñ‚ĞµÑÑŒ ĞºĞ°Ğº Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ÑŒ Ñ Ğ¿Ñ€Ğ°Ğ²Ğ°Ğ¼Ğ¸ Ñ‚ĞµÑ…Ğ½Ğ¸ĞºĞ°/Ğ°Ğ´Ğ¼Ğ¸Ğ½Ğ°",
        );
        $this->line(
            "3. ĞĞ±Ñ€Ğ°Ñ‚Ğ¸Ñ‚Ğµ Ğ²Ğ½Ğ¸Ğ¼Ğ°Ğ½Ğ¸Ğµ Ğ½Ğ° Ğ¸ĞºĞ¾Ğ½ĞºÑƒ ÑƒĞ²ĞµĞ´Ğ¾Ğ¼Ğ»ĞµĞ½Ğ¸Ğ¹ Ğ² Ğ¿Ñ€Ğ°Ğ²Ğ¾Ğ¼ Ğ²ĞµÑ€Ñ…Ğ½ĞµĞ¼ ÑƒĞ³Ğ»Ñƒ",
        );
        $this->line(
            "4. Ğ‘ĞµĞ¹Ğ´Ğ¶ Ğ´Ğ¾Ğ»Ğ¶ĞµĞ½ Ğ¿Ğ¾ĞºĞ°Ğ·Ñ‹Ğ²Ğ°Ñ‚ÑŒ ĞºĞ¾Ğ»Ğ¸Ñ‡ĞµÑÑ‚Ğ²Ğ¾ Ğ½ĞµĞ¿Ñ€Ğ¾Ñ‡Ğ¸Ñ‚Ğ°Ğ½Ğ½Ñ‹Ñ… ÑƒĞ²ĞµĞ´Ğ¾Ğ¼Ğ»ĞµĞ½Ğ¸Ğ¹",
        );
        $this->line("5. ĞšĞ»Ğ¸ĞºĞ½Ğ¸Ñ‚Ğµ Ğ¿Ğ¾ Ğ¸ĞºĞ¾Ğ½ĞºĞµ, Ñ‡Ñ‚Ğ¾Ğ±Ñ‹ Ğ¾Ñ‚ĞºÑ€Ñ‹Ñ‚ÑŒ ÑĞ¿Ğ¸ÑĞ¾Ğº ÑƒĞ²ĞµĞ´Ğ¾Ğ¼Ğ»ĞµĞ½Ğ¸Ğ¹");

        $this->newLine();
        $this->info("ğŸ”— ĞŸĞ¾Ğ»ĞµĞ·Ğ½Ñ‹Ğµ URL Ğ´Ğ»Ñ Ñ‚ĞµÑÑ‚Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ API:");
        $baseUrl = config("app.url", "http://localhost");
        $this->line("- GET {$baseUrl}/api/notifications/unread-count");
        $this->line("- GET {$baseUrl}/api/notifications");
        $this->line("- GET {$baseUrl}/api/notifications/poll");

        $this->newLine();
        $this->comment(
            "ğŸ’¡ Ğ¡Ğ¾Ğ²ĞµÑ‚: ĞÑ‚ĞºÑ€Ğ¾Ğ¹Ñ‚Ğµ Ğ±Ñ€Ğ°ÑƒĞ·ĞµÑ€ÑĞºĞ¸Ğµ Ğ¸Ğ½ÑÑ‚Ñ€ÑƒĞ¼ĞµĞ½Ñ‚Ñ‹ Ñ€Ğ°Ğ·Ñ€Ğ°Ğ±Ğ¾Ñ‚Ñ‡Ğ¸ĞºĞ° (F12) Ğ¸ Ğ¿ĞµÑ€ĞµĞ¹Ğ´Ğ¸Ñ‚Ğµ Ğ½Ğ° Ğ²ĞºĞ»Ğ°Ğ´ĞºÑƒ Network, Ñ‡Ñ‚Ğ¾Ğ±Ñ‹ Ğ²Ğ¸Ğ´ĞµÑ‚ÑŒ AJAX Ğ·Ğ°Ğ¿Ñ€Ğ¾ÑÑ‹ Ğ² Ñ€ĞµĞ°Ğ»ÑŒĞ½Ğ¾Ğ¼ Ğ²Ñ€ĞµĞ¼ĞµĞ½Ğ¸.",
        );

        return 0;
    }

    private function createTestNotification(User $user)
    {
        // Ğ¡Ğ¾Ğ·Ğ´Ğ°ĞµĞ¼ ÑƒĞ²ĞµĞ´Ğ¾Ğ¼Ğ»ĞµĞ½Ğ¸Ğµ Ğ½Ğ°Ğ¿Ñ€ÑĞ¼ÑƒÑ Ñ‡ĞµÑ€ĞµĞ· ÑĞµÑ€Ğ²Ğ¸Ñ
        $this->notificationService->createNotification([
            "user_id" => $user->id,
            "type" => "test",
            "title" => "Ğ¢ĞµÑÑ‚Ğ¾Ğ²Ğ¾Ğµ ÑƒĞ²ĞµĞ´Ğ¾Ğ¼Ğ»ĞµĞ½Ğ¸Ğµ",
            "message" =>
                "Ğ­Ñ‚Ğ¾ Ñ‚ĞµÑÑ‚Ğ¾Ğ²Ğ¾Ğµ ÑƒĞ²ĞµĞ´Ğ¾Ğ¼Ğ»ĞµĞ½Ğ¸Ğµ Ğ´Ğ»Ñ Ğ¿Ñ€Ğ¾Ğ²ĞµÑ€ĞºĞ¸ ÑĞ¸ÑÑ‚ĞµĞ¼Ñ‹. Ğ’Ñ€ĞµĞ¼Ñ: " .
                now()->format("H:i:s"),
            "data" => [
                "test" => true,
                "created_by_command" => true,
            ],
            "url" => route("home"),
        ]);
    }

    private function createTestTicket(User $user): Ticket
    {
        return Ticket::create([
            "title" => "Ğ¢ĞµÑÑ‚Ğ¾Ğ²Ğ°Ñ Ğ·Ğ°ÑĞ²ĞºĞ° - " . now()->format("d.m.Y H:i:s"),
            "description" =>
                "Ğ­Ñ‚Ğ¾ Ñ‚ĞµÑÑ‚Ğ¾Ğ²Ğ°Ñ Ğ·Ğ°ÑĞ²ĞºĞ°, ÑĞ¾Ğ·Ğ´Ğ°Ğ½Ğ½Ğ°Ñ ĞºĞ¾Ğ¼Ğ°Ğ½Ğ´Ğ¾Ğ¹ Ğ´Ğ»Ñ Ğ¿Ñ€Ğ¾Ğ²ĞµÑ€ĞºĞ¸ ÑĞ¸ÑÑ‚ĞµĞ¼Ñ‹ ÑƒĞ²ĞµĞ´Ğ¾Ğ¼Ğ»ĞµĞ½Ğ¸Ğ¹.",
            "category" => "testing",
            "priority" => "medium",
            "status" => "open",
            "reporter_name" => $user->name,
            "reporter_email" => $user->email,
            "user_id" => $user->id,
        ]);
    }
}
