<?php

namespace Database\Seeders;

use App\Models\HomepageFAQ;
use App\Models\User;
use Illuminate\Database\Console\Seeds\WithoutModelEvents;
use Illuminate\Database\Seeder;
use Illuminate\Support\Str;

class HomepageFAQSeeder extends Seeder
{
    /**
     * Run the database seeds.
     */
    public function run(): void
    {
        // Найдем первого админа для назначения автором
        $admin = User::whereHas("role", function ($query) {
            $query->where("slug", "admin");
        })->first();

        $faqs = [
            [
                "title" => "Как подать заявку в службу технической поддержки?",
                "excerpt" =>
                    "Пошаговое руководство по созданию заявки в системе",
                "markdown" =>
                    "## Создание заявки\n\n1. Войдите в систему под своими учетными данными\n2. Нажмите кнопку **\"Подать заявку\"** в верхнем меню\n3. Заполните все необходимые поля:\n   - Выберите категорию проблемы\n   - Укажите приоритет\n   - Опишите проблему максимально подробно\n4. Нажмите кнопку **\"Создать заявку\"**\n\nВаша заявка будет автоматически направлена специалистам технической поддержки.",
                "sort_order" => 1,
                "is_active" => true,
            ],
            [
                "title" => "Где найти номер моей заявки?",
                "excerpt" => "Как найти и отследить статус своей заявки",
                "markdown" =>
                    "## Отслеживание заявки\n\n### В системе:\n1. Перейдите в раздел **\"Мои заявки\"**\n2. Найдите свою заявку в списке\n3. Номер заявки указан в первой колонке\n\n### В уведомлениях:\nНомер заявки также указывается:\n- В письме-подтверждении на email\n- В уведомлениях о смене статуса\n- В комментариях специалистов\n\n*Сохраните номер заявки для быстрого обращения к специалистам*",
                "sort_order" => 2,
                "is_active" => true,
            ],
            [
                "title" => "Что делать, если компьютер не включается?",
                "excerpt" =>
                    "Базовые шаги диагностики проблем с запуском компьютера",
                "markdown" =>
                    "## Диагностика проблем с запуском\n\n### Проверьте основы:\n1. **Питание**: убедитесь, что кабель питания подключен\n2. **Кнопка питания**: попробуйте удерживать кнопку 5-10 секунд\n3. **Индикаторы**: обратите внимание на светодиоды и звуки\n\n### Если не помогло:\n1. Проверьте соединение монитора с системным блоком\n2. Отключите все USB-устройства\n3. Попробуйте другую розетку\n\n### Когда обращаться в поддержку:\n- Нет реакции на кнопку питания\n- Слышны необычные звуки\n- Мигают индикаторы ошибок\n\n**Важно**: не пытайтесь вскрывать корпус самостоятельно!",
                "sort_order" => 3,
                "is_active" => true,
            ],
            [
                "title" => "Как сбросить забытый пароль?",
                "excerpt" =>
                    "Инструкция по восстановлению доступа к учетной записи",
                "markdown" =>
                    "## Восстановление пароля\n\n### Самостоятельное восстановление:\n1. На странице входа нажмите **\"Забыли пароль?\"**\n2. Введите свой email-адрес\n3. Проверьте почту и следуйте инструкциям\n\n### Если письмо не пришло:\n- Проверьте папку \"Спам\"\n- Убедитесь в правильности email-адреса\n- Подождите несколько минут\n\n### Обращение в поддержку:\nЕсли самостоятельно восстановить пароль не удается:\n1. Создайте заявку с темой \"Сброс пароля\"\n2. Укажите свое ФИО и должность\n3. Приложите скриншот ошибки (если есть)\n\n*Специалист свяжется с вами для подтверждения личности*",
                "sort_order" => 4,
                "is_active" => true,
            ],
            [
                "title" => "Почему медленно работает интернет?",
                "excerpt" =>
                    "Возможные причины низкой скорости интернета и способы их устранения",
                "markdown" =>
                    "## Диагностика скорости интернета\n\n### Быстрая проверка:\n1. Закройте все ненужные программы\n2. Перезапустите браузер\n3. Проверьте скорость на speedtest.net\n\n### Возможные причины:\n- **Много активных загрузок** - приостановите обновления\n- **Проблемы с Wi-Fi** - попробуйте кабельное подключение\n- **Вирусы** - запустите антивирусную проверку\n- **Устаревший браузер** - обновите до последней версии\n\n### Когда обращаться в IT:\n- Скорость стабильно ниже 10 Мбит/с\n- Постоянные обрывы соединения\n- Проблема затрагивает весь отдел\n\n**Совет**: при создании заявки укажите результаты теста скорости",
                "sort_order" => 5,
                "is_active" => true,
            ],
            [
                "title" => "Как подключить принтер к компьютеру?",
                "excerpt" =>
                    "Пошаговая инструкция по подключению и настройке принтера",
                "markdown" =>
                    "## Подключение принтера\n\n### USB-принтер:\n1. Подключите принтер к компьютеру USB-кабелем\n2. Включите принтер\n3. Дождитесь автоматической установки драйверов\n4. Проверьте печать тестовой страницы\n\n### Сетевой принтер:\n1. Откройте **\"Параметры\" → \"Принтеры и сканеры\"**\n2. Нажмите **\"Добавить принтер или сканер\"**\n3. Выберите нужный принтер из списка\n4. Следуйте инструкциям мастера установки\n\n### Если принтер не найден:\n- Убедитесь, что принтер включен\n- Проверьте подключение кабелей\n- Перезагрузите принтер\n- Обратитесь в IT-поддержку\n\n*Для корпоративных принтеров может потребоваться специальная настройка*",
                "sort_order" => 6,
                "is_active" => false, // Этот FAQ неактивен для демонстрации
            ],
        ];

        foreach ($faqs as $faqData) {
            $faq = new HomepageFAQ();
            $faq->title = $faqData["title"];
            $faq->slug = Str::slug($faqData["title"]);
            $faq->excerpt = $faqData["excerpt"];
            $faq->markdown = $faqData["markdown"];

            // Конвертируем markdown в HTML (упрощенная версия)
            $content = $faqData["markdown"];
            $content = preg_replace("/## (.+)/", '<h2>$1</h2>', $content);
            $content = preg_replace("/### (.+)/", '<h3>$1</h3>', $content);
            $content = preg_replace(
                "/\*\*(.+?)\*\*/",
                '<strong>$1</strong>',
                $content,
            );
            $content = preg_replace("/\*(.+?)\*/", '<em>$1</em>', $content);
            $content = str_replace("\n\n", "</p><p>", $content);
            $content = str_replace("\n", "<br>", $content);
            $content = "<p>" . $content . "</p>";

            $faq->content = $content;
            $faq->sort_order = $faqData["sort_order"];
            $faq->is_active = $faqData["is_active"];
            $faq->author_id = $admin ? $admin->id : null;

            $faq->save();
        }
    }
}
